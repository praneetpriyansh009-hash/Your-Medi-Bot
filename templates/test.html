<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Medi Bot - AI Companion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 35%, rgba(51, 65, 85, 0.85) 100%),
                        url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover; background-position: center center; background-attachment: fixed;
            padding: 20px; display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; color: #e2e8f0; position: relative;
        }
        
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.7) 0%, rgba(30, 41, 59, 0.6) 50%, rgba(51, 65, 85, 0.5) 100%);
            z-index: -1;
        }
        
        .chat-container { 
            max-width: 800px; width: 100%; height: 95vh; 
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 20px; 
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; flex-direction: column; transition: all 0.4s ease;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .chat-header {
            text-align: center; margin-bottom: 20px; padding: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            background-image: url('https://images.unsplash.com/photo-1576091160399-112ba8d25d1f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover; background-position: center; border-radius: 15px;
        }
        
        .chat-header h2 {
            font-family: 'Playfair Display', serif; color: #ffffff; font-size: 32px;
            font-weight: 700; margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
        
        .chat-header p { color: rgba(255, 255, 255, 0.9); font-size: 16px; }
        .about-section { margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .about-content h3 { color: #ffffff; margin-bottom: 10px; font-size: 18px; }
        .about-content p { color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.5; }
        
        .messages { 
            overflow-y: auto; flex-grow: 1; padding: 10px;
            border-radius: 15px; margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.15);
        }
        
        .message {
            display: flex; max-width: 75%; margin-bottom: 12px;
            padding: 12px 18px; border-radius: 20px;
            line-height: 1.4; animation: fadeIn 0.5s;
        }
        
        .bot-message {
            background: linear-gradient(135deg, #8f94fb, #4e54c8); color: white;
            border-bottom-left-radius: 5px; margin-right: auto;
        }
        
        .user-message {
            background: linear-gradient(135deg, #09203f, #537895); color: white;
            border-bottom-right-radius: 5px; margin-left: auto;
        }

        .error-message {
            background-color: #ff5252; color: white;
            border-bottom-left-radius: 5px; margin-right: auto;
            font-style: italic;
        }

        .message strong { margin-right: 8px; }
        
        .input-container { display: flex; gap: 10px; align-items: center; }
        
        #userInput {
            flex: 1; padding: 14px 18px; border: 2px solid rgba(255, 255, 255, 0.2); 
            border-radius: 25px; font-size: 16px; outline: none;
            transition: all 0.3s ease; background: rgba(0, 0, 0, 0.2);
            color: #ffffff;
        }
        #userInput:focus { border-color: #8f94fb; }
        
        .action-btn {
            padding: 14px 20px; border: none; border-radius: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; cursor: pointer; font-weight: 500; font-size: 16px;
            transition: all 0.3s ease;
        }
        .action-btn:hover { transform: scale(1.05); }

        .loading { display: none; margin: 10px 0; }
        .typing-indicator {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(0, 0, 0, 0.2); padding: 10px 16px;
            border-radius: 20px;
        }
        .typing-dot {
            width: 8px; height: 8px; background: rgba(255, 255, 255, 0.7);
            border-radius: 50%; animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>Your Medi Bot</h2>
            <p>Your compassionate AI companion for medical wellness</p>
            <div class="about-section">
                <div class="about-content">
                    <p>Remember: This is an AI assistant and not a substitute for professional medical advice.</p>
                </div>
            </div>
        </div>
        
        <div class="messages" id="messages">
            <div class="message bot-message"><strong>Bot:</strong>Welcome! How can I assist you today? You can ask me questions or upload an image of a medical report or injury for a general explanation.</div>
        </div>
        
        <div class="loading" id="loading">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="input-container">
            <input type="file" id="imageInput" accept="image/*" style="display:none;">
            <button class="action-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
            <input type="text" id="userInput" placeholder="Type your message...">
            <button class="action-btn" id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const imageInput = document.getElementById('imageInput');
        const loadingIndicator = document.getElementById('loading');

        /**
         * Appends a message to the chat window.
         * @param {string} content The message text.
         * @param {string} senderClass The CSS class for the sender ('user-message', 'bot-message', 'error-message').
         * @param {string} senderName The name of the sender ('You' or 'Bot').
         */
        function appendMessage(content, senderClass, senderName) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${senderClass}`;
            
            const strongTag = document.createElement('strong');
            strongTag.innerText = `${senderName}:`;
            
            const textNode = document.createTextNode(` ${content}`);
            
            msgDiv.appendChild(strongTag);
            msgDiv.appendChild(textNode);
            
            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function handleSendMessage() {
            const messageText = userInput.value.trim();
            if (messageText === '') return;

            appendMessage(messageText, 'user-message', 'You');
            userInput.value = '';
            loadingIndicator.style.display = 'block';

            try {
                const response = await fetch("/get-response", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: messageText })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();
                const reply = data.response || data.error || "No response from bot.";
                appendMessage(reply, 'bot-message', 'Bot');

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("Could not connect to the server. Please check your connection and try again.", 'error-message', 'Error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        async function handleSendImage(file) {
            if (!file) return;
            
            appendMessage("Sent an image ðŸ“·", 'user-message', 'You');
            loadingIndicator.style.display = 'block';
            
            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch("/analyze-image", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();
                const reply = data.response || data.error || "Could not analyze the image.";
                appendMessage(reply, 'bot-message', 'Bot');

            } catch (error) {
                console.error("Image Upload Error:", error);
                appendMessage("Failed to upload or analyze the image. Please try again.", 'error-message', 'Error');
            } finally {
                loadingIndicator.style.display = 'none';
                imageInput.value = ''; // Reset file input
            }
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });
        imageInput.addEventListener('change', (e) => {
            handleSendImage(e.target.files[0]);
        });
    </script>
    <script>
async function sendMessage() {
    let message = document.getElementById("userInput").value;
    let response = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: message})
    });
    let data = await response.json();
    document.getElementById("chatBox").innerHTML += "<p>You: " + message + "</p>";
    document.getElementById("chatBox").innerHTML += "<p>Bot: " + data.reply + "</p>";
}
</script>
</body>
</html>